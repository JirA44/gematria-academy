<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="page_title">Atelier Mandala - Acad√©mie des Runes & Gematria</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="fix-contrast.css">
    <script src="dark-mode-auto.js"></script>
    <style>
        .mandala-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .upload-section {
            text-align: center;
            padding: 2rem;
            background: var(--card-bg, #f5f5f5);
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px dashed var(--accent, #8b7355);
        }

        .upload-section.dragover {
            background: var(--accent-light, #d4c4b0);
            border-color: var(--accent-dark, #6b5335);
        }

        .file-input-label {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent, #8b7355), var(--accent-dark, #6b5335));
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        #fileInput {
            display: none;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .mandala-card {
            background: var(--card-bg, white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .mandala-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .mandala-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .mandala-card-info {
            padding: 1rem;
            text-align: center;
        }

        .canvas-workspace {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow: auto;
        }

        .canvas-workspace.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .canvas-controls {
            background: var(--card-bg, white);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .color-palette {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-btn:hover,
        .color-btn.active {
            transform: scale(1.2);
            border-color: #333;
        }

        .tool-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--accent, #8b7355);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .tool-btn:hover,
        .tool-btn.active {
            background: var(--accent, #8b7355);
            color: white;
        }

        .brush-size {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #mandalaCanvas {
            border: 3px solid var(--accent, #8b7355);
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            max-width: 90vw;
            max-height: 70vh;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1001;
        }

        .close-btn:hover {
            background: #c0392b;
        }

        .preset-mandalas {
            margin-top: 3rem;
        }

        .preset-mandalas h3 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-primary, #333);
        }

        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            text-align: center;
        }

        .info-box h3 {
            margin-top: 0;
        }

        .dark-mode .upload-section {
            background: #2d3748;
            border-color: #a0826d;
        }

        .dark-mode .mandala-card {
            background: #2d3748;
        }

        .dark-mode .canvas-controls {
            background: #2d3748;
            color: white;
        }

        .dark-mode .tool-btn {
            background: #1a202c;
            color: white;
            border-color: #a0826d;
        }

        .dark-mode .tool-btn:hover,
        .dark-mode .tool-btn.active {
            background: #a0826d;
        }
    </style>
</head>
<body>
    <header>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô Mode Nuit</button>
        <button class="lang-toggle" onclick="toggleLanguage()">üåê EN</button>
        <h1 data-i18n="title">üé® Atelier Mandala</h1>
        <p class="subtitle" data-i18n="subtitle">Cr√©ez et coloriez vos mandalas sacr√©s</p>
    </header>

    <nav>
        <div class="nav-container">
            <a href="index_multilingual.html" data-i18n="nav_home">Accueil</a>
            <a href="alphabet-runes.html" data-i18n="nav_runes">Runes</a>
            <a href="alphabet-hebreu.html" data-i18n="nav_gematria">Gematria</a>
            <a href="mandala.html" class="active" data-i18n="nav_mandala">Mandala</a>
        </div>
    </nav>

    <main class="mandala-container">
        <div class="info-box">
            <h3 data-i18n="info_title">üïâÔ∏è Le Mandala : G√©om√©trie Sacr√©e</h3>
            <p data-i18n="info_text">
                Les mandalas sont des repr√©sentations symboliques de l'univers dans les traditions bouddhistes et hindoues.
                Chaque mandala est un outil de m√©ditation qui repr√©sente l'harmonie cosmique.
                Colorier un mandala est une pratique m√©ditative qui favorise la concentration et la paix int√©rieure.
            </p>
        </div>

        <section class="upload-section" id="uploadZone">
            <h2 data-i18n="upload_title">üì§ Ajoutez vos Mandalas</h2>
            <p data-i18n="upload_text">Glissez-d√©posez vos images ou cliquez pour s√©lectionner</p>
            <label for="fileInput" class="file-input-label" data-i18n="upload_btn">
                Choisir une image
            </label>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </section>

        <section class="user-mandalas" id="userMandalasSection" style="display: none;">
            <h3 data-i18n="user_mandalas_title">Vos Mandalas</h3>
            <div class="gallery-grid" id="userGallery"></div>
        </section>

        <section class="preset-mandalas">
            <h3 data-i18n="preset_title">üå∏ Collection de Mandalas</h3>
            <div class="gallery-grid" id="presetGallery"></div>
        </section>
    </main>

    <div class="canvas-workspace" id="canvasWorkspace">
        <button class="close-btn" onclick="closeWorkspace()" title="Fermer">√ó</button>

        <div class="canvas-controls">
            <div class="color-palette" id="colorPalette"></div>

            <div class="brush-size">
                <label data-i18n="brush_size">Taille:</label>
                <input type="range" id="brushSize" min="1" max="30" value="5">
                <span id="brushSizeValue">5px</span>
            </div>

            <button class="tool-btn" id="pencilBtn" onclick="setTool('pencil')" data-i18n="tool_pencil">‚úèÔ∏è Crayon</button>
            <button class="tool-btn" id="eraserBtn" onclick="setTool('eraser')" data-i18n="tool_eraser">üßπ Gomme</button>
            <button class="tool-btn" onclick="clearCanvas()" data-i18n="tool_clear">üóëÔ∏è Effacer tout</button>
            <button class="tool-btn" onclick="saveImage()" data-i18n="tool_save">üíæ Sauvegarder</button>
            <button class="tool-btn" onclick="resetImage()" data-i18n="tool_reset">üîÑ R√©initialiser</button>
        </div>

        <canvas id="mandalaCanvas"></canvas>
    </div>

    <footer>
        <p data-i18n="footer">¬© 2025 Acad√©mie des Runes & Gematria - L'art du mandala</p>
    </footer>

    <script>
        // Variables globales
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = '#000000';
        let currentTool = 'pencil';
        let brushSize = 5;
        let currentImage = null;
        let uploadedImages = [];

        // Palette de couleurs
        const colors = [
            '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF',
            '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080',
            '#FFC0CB', '#A52A2A', '#808080', '#FFD700', '#90EE90',
            '#E6E6FA', '#FF6347', '#4169E1', '#32CD32', '#FF1493'
        ];

        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('mandalaCanvas');
            ctx = canvas.getContext('2d');

            // Charger les images upload√©es depuis localStorage
            loadUploadedImages();

            // Cr√©er la palette de couleurs
            createColorPalette();

            // Event listeners pour le dessin
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events pour mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);

            // Upload de fichiers
            const fileInput = document.getElementById('fileInput');
            const uploadZone = document.getElementById('uploadZone');

            fileInput.addEventListener('change', handleFileSelect);

            // Drag & Drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFileSelect({ target: { files: e.dataTransfer.files } });
            });

            // Brush size
            const brushSizeInput = document.getElementById('brushSize');
            brushSizeInput.addEventListener('input', (e) => {
                brushSize = e.target.value;
                document.getElementById('brushSizeValue').textContent = brushSize + 'px';
            });

            // Activer le crayon par d√©faut
            setTool('pencil');
        });

        function createColorPalette() {
            const palette = document.getElementById('colorPalette');
            colors.forEach((color, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn' + (index === 0 ? ' active' : '');
                btn.style.backgroundColor = color;
                btn.onclick = () => selectColor(color, btn);
                palette.appendChild(btn);
            });

            // Ajout d'un s√©lecteur de couleur personnalis√©
            const customColor = document.createElement('input');
            customColor.type = 'color';
            customColor.className = 'color-btn';
            customColor.style.width = '40px';
            customColor.style.height = '40px';
            customColor.style.cursor = 'pointer';
            customColor.onchange = (e) => selectColor(e.target.value, customColor);
            palette.appendChild(customColor);
        }

        function selectColor(color, btn) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (currentTool === 'eraser') {
                setTool('pencil');
            }
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Btn').classList.add('active');
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = event.target.result;
                    uploadedImages.push({
                        name: file.name,
                        data: imageData,
                        date: new Date().toISOString()
                    });
                    saveUploadedImages();
                    displayUserGallery();
                };
                reader.readAsDataURL(file);
            });
        }

        function saveUploadedImages() {
            try {
                localStorage.setItem('mandalaImages', JSON.stringify(uploadedImages));
            } catch (e) {
                console.warn('LocalStorage full, keeping only recent images');
                uploadedImages = uploadedImages.slice(-10);
                localStorage.setItem('mandalaImages', JSON.stringify(uploadedImages));
            }
        }

        function loadUploadedImages() {
            const stored = localStorage.getItem('mandalaImages');
            if (stored) {
                uploadedImages = JSON.parse(stored);
                displayUserGallery();
            }
        }

        function displayUserGallery() {
            const section = document.getElementById('userMandalasSection');
            const gallery = document.getElementById('userGallery');

            if (uploadedImages.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            gallery.innerHTML = '';

            uploadedImages.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'mandala-card';
                card.innerHTML = `
                    <img src="${img.data}" alt="${img.name}">
                    <div class="mandala-card-info">
                        <p>${img.name}</p>
                    </div>
                `;
                card.onclick = () => openMandala(img.data);
                gallery.appendChild(card);
            });
        }

        function openMandala(imageData) {
            const img = new Image();
            img.onload = () => {
                // Adapter la taille du canvas √† l'image
                const maxWidth = window.innerWidth * 0.9;
                const maxHeight = window.innerHeight * 0.7;
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }

                canvas.width = width;
                canvas.height = height;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, width, height);

                currentImage = img;
                document.getElementById('canvasWorkspace').classList.add('active');
            };
            img.src = imageData;
        }

        function closeWorkspace() {
            document.getElementById('canvasWorkspace').classList.remove('active');
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentTool === 'eraser' ? '#FFFFFF' : currentColor;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            if (confirm('Effacer tout le travail ?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (currentImage) {
                    ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
                }
            }
        }

        function resetImage() {
            if (currentImage) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            }
        }

        function saveImage() {
            const link = document.createElement('a');
            link.download = 'mandala_' + Date.now() + '.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Mode Nuit
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            const btn = document.querySelector('.dark-mode-toggle');
            btn.textContent = isDark ? '‚òÄÔ∏è Mode Jour' : 'üåô Mode Nuit';
        }

        // Charger la pr√©f√©rence au d√©marrage
        window.addEventListener('DOMContentLoaded', () => {
            const darkMode = localStorage.getItem('darkMode');
            const isDark = darkMode === null ? true : darkMode === 'true';

            if (isDark) {
                document.body.classList.add('dark-mode');
                const btn = document.querySelector('.dark-mode-toggle');
                if (btn) btn.textContent = '‚òÄÔ∏è Mode Jour';
            }

            if (darkMode === null) {
                localStorage.setItem('darkMode', 'true');
            }
        });

        // Syst√®me de traduction
        const translations = {
            fr: {
                page_title: "Atelier Mandala - Acad√©mie des Runes & Gematria",
                title: "üé® Atelier Mandala",
                subtitle: "Cr√©ez et coloriez vos mandalas sacr√©s",
                nav_home: "Accueil",
                nav_runes: "Runes",
                nav_gematria: "Gematria",
                nav_mandala: "Mandala",
                info_title: "üïâÔ∏è Le Mandala : G√©om√©trie Sacr√©e",
                info_text: "Les mandalas sont des repr√©sentations symboliques de l'univers dans les traditions bouddhistes et hindoues. Chaque mandala est un outil de m√©ditation qui repr√©sente l'harmonie cosmique. Colorier un mandala est une pratique m√©ditative qui favorise la concentration et la paix int√©rieure.",
                upload_title: "üì§ Ajoutez vos Mandalas",
                upload_text: "Glissez-d√©posez vos images ou cliquez pour s√©lectionner",
                upload_btn: "Choisir une image",
                user_mandalas_title: "Vos Mandalas",
                preset_title: "üå∏ Collection de Mandalas",
                brush_size: "Taille:",
                tool_pencil: "‚úèÔ∏è Crayon",
                tool_eraser: "üßπ Gomme",
                tool_clear: "üóëÔ∏è Effacer tout",
                tool_save: "üíæ Sauvegarder",
                tool_reset: "üîÑ R√©initialiser",
                footer: "¬© 2025 Acad√©mie des Runes & Gematria - L'art du mandala"
            },
            en: {
                page_title: "Mandala Workshop - Academy of Runes & Gematria",
                title: "üé® Mandala Workshop",
                subtitle: "Create and color your sacred mandalas",
                nav_home: "Home",
                nav_runes: "Runes",
                nav_gematria: "Gematria",
                nav_mandala: "Mandala",
                info_title: "üïâÔ∏è The Mandala: Sacred Geometry",
                info_text: "Mandalas are symbolic representations of the universe in Buddhist and Hindu traditions. Each mandala is a meditation tool representing cosmic harmony. Coloring a mandala is a meditative practice that promotes concentration and inner peace.",
                upload_title: "üì§ Add Your Mandalas",
                upload_text: "Drag and drop your images or click to select",
                upload_btn: "Choose an image",
                user_mandalas_title: "Your Mandalas",
                preset_title: "üå∏ Mandala Collection",
                brush_size: "Size:",
                tool_pencil: "‚úèÔ∏è Pencil",
                tool_eraser: "üßπ Eraser",
                tool_clear: "üóëÔ∏è Clear all",
                tool_save: "üíæ Save",
                tool_reset: "üîÑ Reset",
                footer: "¬© 2025 Academy of Runes & Gematria - The art of mandala"
            }
        };

        let currentLang = 'fr';

        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            localStorage.setItem('language', currentLang);
            applyTranslations();
            const btn = document.querySelector('.lang-toggle');
            btn.textContent = currentLang === 'fr' ? 'üåê EN' : 'üåê FR';
            document.documentElement.lang = currentLang;
        }

        function applyTranslations() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
        }

        // Charger la langue au d√©marrage
        window.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('language');
            if (savedLang && savedLang !== 'fr') {
                currentLang = savedLang;
                applyTranslations();
                const btn = document.querySelector('.lang-toggle');
                if (btn) btn.textContent = currentLang === 'fr' ? 'üåê EN' : 'üåê FR';
                document.documentElement.lang = currentLang;
            }
        });
    </script>
</body>
</html>
